#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
易經占卜 API 服務器
提供占卜、卦象查詢、AI 解讀等功能
"""
import os
from flask import Flask, request, jsonify
from flask_cors import CORS
from openai import OpenAI
import random
from datetime import datetime
from dotenv import load_dotenv

# ============================================================================
# 🔑 載入 .env 文件中的 API Key（安全方式）
# ============================================================================
# 從 .env 文件載入環境變數
load_dotenv()

# 如果您想直接在這裡填入（不推薦，僅供測試）
# OPENAI_API_KEY = "sk-proj-xxxxx"
# ============================================================================

# ============================================================================

app = Flask(__name__, static_folder='../frontend', static_url_path='')
CORS(app)  # 允許跨域請求

@app.route('/')
def index():
    return app.send_static_file('index.html')

@app.route('/health')
def health_root():
    """根路徑健康檢查 (Zeabur 使用)"""
    return jsonify({'status': 'ok', 'service': 'i-ching', 'openai': 'enabled' if client else 'disabled'})

# OpenAI 初始化
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
if OPENAI_API_KEY:
    client = OpenAI(api_key=OPENAI_API_KEY)
else:
    client = None
    print("⚠️ 警告：未設定 OPENAI_API_KEY")

# 陳老師人設
CHEN_LAOSHI_PERSONA = """
你是資深占卜師「JeanTseng」的數位分身，被稱為「易經占卜陳老師」。

【基本資料】
- 姓名：JeanTseng
- 職業：資料分析師，對於易經占卜稍有研究
- 經驗：超過 20 年資料分析經驗
- 婚姻狀況：已婚，育有一子一女
- 居住地：桃園
- 星座：巨蟹座
- 年齡：不惑之年

【教育背景】
- 東吳大學資料科學研究所

【興趣】
- 旅遊
- 易經卜卦
- 閱讀
- 說笑話

【聯絡方式】
- Email:13773023@scu.edu.tw
- 工作室地址：桃園市

【服務理念】
陳老師認為，易經占卜不是宿命論，而是一種自我認識的工具。
透過易經卦象分析，幫助來訪者了解自己的優勢與挑戰，
從而做出更明智的人生選擇。

【回答風格】
請用溫和、專業、具同理心的語氣回答，像一位值得信賴的長輩或導師。
沒有找到答案，請回答"秘密"
"""

# 八卦數據
TRIGRAMS = {
    0: {'name': '坤', 'symbol': '☷', 'element': '地'},
    1: {'name': '乾', 'symbol': '☰', 'element': '天'},
    2: {'name': '兌', 'symbol': '☱', 'element': '澤'},
    3: {'name': '離', 'symbol': '☲', 'element': '火'},
    4: {'name': '震', 'symbol': '☳', 'element': '雷'},
    5: {'name': '巽', 'symbol': '☴', 'element': '風'},
    6: {'name': '坎', 'symbol': '☵', 'element': '水'},
    7: {'name': '艮', 'symbol': '☶', 'element': '山'},
    8: {'name': '坤', 'symbol': '☷', 'element': '地'}
}

# 64卦數據（完整版 - 包含全部64卦）
HEXAGRAMS = {
    '乾乾': {
        'num': 1,
        'name': '乾為天',
        'meaning': '元亨利貞。剛健中正，自強不息。',
        'fortune': '大吉。帝王之象，諸事亨通，唯需注意物極必反，宜正道而行。',
        'lines': {
            1: "初九：潛龍勿用。（時機未到，宜韜光養晦，累積實力）",
            2: "九二：見龍在田，利見大人。（嶄露頭角，宜尋求貴人提拔）",
            3: "九三：君子終日乾乾，夕惕若厲，無咎。（勤勉謹慎，居安思危，可免災禍）",
            4: "九四：或躍在淵，無咎。（把握良機，進退自如，審時度勢）",
            5: "九五：飛龍在天，利見大人。（登峰造極，大展宏圖，位居尊位）",
            6: "上九：亢龍有悔。（物極必反，知進不知退，恐有悔恨）"
        }
    },
    '坤坤': {
        'num': 2,
        'name': '坤為地',
        'meaning': '元亨，利牝馬之貞。君子有攸往，先迷後得主，利西南得朋，東北喪朋。安貞吉。',
        'fortune': '吉。包容萬物，以柔克剛。宜順勢而為，不宜強出頭，配合他人可成大業。',
        'lines': {
            1: "初六：履霜，堅冰至。（見微知著，防微杜漸，危機將至）",
            2: "六二：直方大，不習無不利。（正直端方，順應自然，無往不利）",
            3: "六三：含章可貞。或從王事，無成有終。（內斂才華，輔佐他人，不居功自有成就）",
            4: "六四：括囊，無咎無譽。（謹言慎行，守口如瓶，明哲保身）",
            5: "六五：黃裳，元吉。（中正柔順，謙虛尊貴，大吉大利）",
            6: "上六：龍戰于野，其血玄黃。（陰陽相爭，兩敗俱傷，局勢混亂）"
        }
    },
    '坎震': {
        'num': 3,
        'name': '水雷屯',
        'meaning': '元亨利貞，勿用有攸往，利建侯。',
        'fortune': '下下（或中平）。萬事起頭難，前途多難，宜守不宜進，需積聚力量。',
        'lines': {
            1: "初九：磐桓，利居貞，利建侯。（進退兩難，宜守正道，建立根基）",
            2: "六二：屯如邅如，乘馬班如。匪寇婚媾。女子貞不字，十年乃字。（困頓難行，分清敵友，堅持等待終有結果）",
            3: "六三：即鹿無虞，惟入于林中，君子幾不如舍，往吝。（盲目追求，迷失方向，不如放棄以免受損）",
            4: "六四：乘馬班如，求婚媾，往吉，無不利。（雖有困難，主動尋求合作，前景吉祥）",
            5: "九五：屯其膏，小貞吉，大貞凶。（恩澤未下，小事可成，大事難為）",
            6: "上六：乘馬班如，泣血漣如。（孤立無援，悲痛絕望，運勢極差）"
        }
    },
    '艮坎': {
        'num': 4,
        'name': '山水蒙',
        'meaning': '亨。匪我求童蒙，童蒙求我。初筮告，再三瀆，瀆則不告。利貞。',
        'fortune': '中下。啟蒙之初，迷茫無知。宜虛心求教，切忌自作聰明，需良師指導。',
        'lines': {
            1: "初六：發蒙，利用刑人，用說桎梏，以往吝。（啟蒙初期，需嚴格管教，導正規範）",
            2: "九二：包蒙吉，納婦吉，子克家。（寬容包納無知者，吉利，能治理好家庭）",
            3: "六三：勿用取女，見金夫，不有躬，無攸利。（切勿盲目追求，見利忘義者不可交，無利可圖）",
            4: "六四：困蒙，吝。（困於無知之中，孤立無援，情況不佳）",
            5: "六五：童蒙，吉。（保持童心般的誠懇謙虛，虛心受教，吉利）",
            6: "上九：擊蒙，不利為寇，利禦寇。（嚴厲治蒙，不可過於殘暴，宜防禦外侮，剛柔並濟）"
        }
    },
    '坎乾': {
        'num': 5,
        'name': '水天需',
        'meaning': '有孚，光亨，貞吉。利涉大川。',
        'fortune': '中上。等待時機，積蓄力量。時機未到不可躁進，耐心等待必有大成。',
        'lines': {
            1: "初九：需于郊。利用恆，無咎。（在郊外等待，保持耐心與恆心，沒有災禍）",
            2: "九二：需于沙。小有言，終吉。（在沙灘等待，雖有口舌是非，最終吉利）",
            3: "九三：需于泥，致寇至。（陷入泥沼，處境艱難，容易招致外敵）",
            4: "六四：需于血，出自穴。（陷入血戰，需聽從指揮，想辦法脫離險境）",
            5: "九五：需于酒食，貞吉。（在酒食中等待，苦盡甘來，放鬆心情，堅守正道吉）",
            6: "上六：入于穴，有不速之客三人來，敬之終吉。（局勢變化，有意外之客到訪，以禮相待則吉）"
        }
    },
    '乾坎': {
        'num': 6,
        'name': '天水訟',
        'meaning': '有孚，窒。惕中吉。終凶。利見大人，不利涉大川。',
        'fortune': '下下。爭執訴訟，口舌是非。凡事宜退一步海闊天空，強爭必凶。',
        'lines': {
            1: "初六：不永所事，小有言，終吉。（爭端不宜久拖，雖有言語摩擦，儘早化解則吉）",
            2: "九二：不克訟，歸而逋，其邑人三百戶，無眚。（訴訟失利，應速退避反省，可免災禍）",
            3: "六三：食舊德，貞厲，終吉。或從王事，無成。（安守本分，享受舊有成果，雖有危險但終吉）",
            4: "九四：不克訟，復即命，渝安貞，吉。（知難而退，改變心意，安分守己，吉利）",
            5: "九五：訟，元吉。（公正裁決，平息爭端，大吉大利）",
            6: "上九：或錫之鞶帶，終朝三褫之。（雖獲勝得賞，但榮耀不長久，反覆受辱，得不償失）"
        }
    },
    '坤坎': {
        'num': 7,
        'name': '地水師',
        'meaning': '貞，丈人，吉無咎。',
        'fortune': '中上。興師動眾，統率群眾。需有威望者領導，紀律嚴明，否則有凶。',
        'lines': {
            1: "初六：師出以律，否臧凶。（出師需有紀律，軍紀渙散必敗）",
            2: "九二：在師中，吉無咎，王三錫命。（主帥坐鎮軍中，指揮若定，受君王重賞，吉）",
            3: "六三：師或輿尸，凶。（指揮不當，可能載屍而歸，大敗之象）",
            4: "六四：師左次，無咎。（審時度勢，暫時後退駐紮，保存實力，無災）",
            5: "六五：田有禽，利執言，無咎。長子帥師，弟子輿尸，貞凶。（除害安民，應由老成持重者指揮，若用人不當則凶）",
            6: "上六：大君有命，開國承家，小人勿用。（戰爭結束，論功行賞，分封諸侯，切不可重用小人）"
        }
    },
    '坎坤': {
        'num': 8,
        'name': '水地比',
        'meaning': '吉。原筮元永貞，無咎。不寧方來，後夫凶。',
        'fortune': '上上。親密比輔，和樂相處。宜主動結交賢人，團隊合作，遲疑者錯失良機。',
        'lines': {
            1: "初六：有孚比之，無咎。有孚盈缶，終來有他吉。（誠信結交，無災。誠意滿滿，會有意外之喜）",
            2: "六二：比之自內，貞吉。（發自內心的誠意交往，堅守正道，吉利）",
            3: "六三：比之匪人。（與行為不端者交往，所託非人，應當警惕）",
            4: "六四：外比之，貞吉。（向外結交賢德之人，吉利）",
            5: "九五：顯比，王用三驅，失前禽。邑人不警戒，吉。（光明正大的親比，寬宏大量，來者不拒去者不追，吉）",
            6: "上六：比之無首，凶。（想依附卻找不到領袖，或誠意不足，最終無人理睬，凶）"
        }
    },
    '巽乾': {
        'num': 9,
        'name': '風天小畜',
        'meaning': '亨。密雲不雨，自我西郊。',
        'fortune': '中下。力量微薄，時機未熟。蓄養實力，暫時受阻，宜忍耐等待，不可強行突破。',
        'lines': {
            1: "初九：復自道，何其咎，吉。（迷途知返，回到正道，無災吉利）",
            2: "九二：牽復，吉。（被牽引著回到正道，吉利）",
            3: "九三：輿說輻，夫妻反目。（車輪脫落，夫妻失和，基礎動搖，內部矛盾）",
            4: "六四：有孚，血去惕出，無咎。（心懷誠信，避免流血與恐懼，無災）",
            5: "九五：有孚攣如，富以其鄰。（誠信連結，與鄰居共享財富，互助互利）",
            6: "上九：既雨既處，尚德載，婦貞厲。月幾望，君子征凶。（雨已降下，陰氣過盛，君子若再出征則凶，宜安守現狀）"
        }
    },
    '乾兌': {
        'num': 10,
        'name': '天澤履',
        'meaning': '履虎尾，不咥人，亨。',
        'fortune': '中上（或驚險）。如履薄冰，伴君如伴虎。雖有危險，但若小心謹慎、應對得體，終能化險為夷。',
        'lines': {
            1: "初九：素履，往無咎。（行為樸素，安守本分，前往無災）",
            2: "九二：履道坦坦，幽人貞吉。（大道平坦，心無雜念，安靜恬淡者吉）",
            3: "六三：眇能視，跛能履，履虎尾，咥人，凶。武人為于大君。（才德不足而逞強，如盲者視、跛者行，踩虎尾遭噬，凶）",
            4: "九四：履虎尾，愬愬終吉。（踩到虎尾，恐懼謹慎，最終吉利）",
            5: "九五：夬履，貞厲。（剛愎自用，獨斷獨行，即使正當也暗藏危險）",
            6: "上九：視履考祥，其旋元吉。（回顧所行之路，考察禍福，若圓滿周全則大吉）"
        }
    },
    
    # 第11-20卦
    '坤乾': {
        'num': 11,
        'name': '地天泰',
        'meaning': '小往大來，吉亨。',
        'fortune': '上上。三陽開泰，陰陽和合，諸事順遂，適合創業、嫁娶、求職。',
        'lines': {
            1: "初九：拔茅茹，以其彙，征吉。（團結一心，引薦賢才，共同進取則吉）",
            2: "九二：包荒，用馮河，不遐遺，朋亡，得尚于中行。（寬容大度，果敢決斷，不結黨營私，合乎中道）",
            3: "九三：無平不陂，無往不復，艱貞無咎。勿恤其孚，于食有福。（世事無常，居安思危，堅守正道可保福氣）",
            4: "六四：翩翩，不富以其鄰，不戒以孚。（虛心下士，不靠財富而靠誠信聚集人心）",
            5: "六五：帝乙歸妹，以祉元吉。（屈尊降貴，柔順謙和，大吉大利）",
            6: "上六：城復于隍，勿用師。自邑告命，貞吝。（泰極否來，局勢逆轉，不宜動武，需自我反省）"
        }
    },
    '乾坤': {
        'num': 12,
        'name': '天地否',
        'meaning': '否之匪人，不利君子貞，大往小來。',
        'fortune': '下下。閉塞不通，小人當道，君子受排擠，宜退避三舍，韜光養晦。',
        'lines': {
            1: "初六：拔茅茹，以其彙，貞吉亨。（君子道消，相約引退，獨善其身為吉）",
            2: "六二：包承，小人吉，大人否亨。（阿諛奉承小人得志，君子堅持原則雖受困但內心通達）",
            3: "六三：包羞。（同流合污，不知羞恥，處境尷尬）",
            4: "九四：有命無咎，修列吉。（奉命行事，整頓秩序，可免災禍）",
            5: "九五：休否，大人吉。其亡其亡，繫于苞桑。（終止混亂，居安思危，像綁在桑樹一樣牢固）",
            6: "上九：傾否，先否後喜。（否極泰來，黑暗過去，光明將至）"
        }
    },
    '乾離': {
        'num': 13,
        'name': '天火同人',
        'meaning': '同人于野，亨。利涉大川，利君子貞。',
        'fortune': '中上。上下和同，合作共事。宜廣結善緣，團結眾人，利於合夥事業。',
        'lines': {
            1: "初九：同人于門，無咎。（走出家門，廣泛交友，無門戶之見，吉）",
            2: "六二：同人于宗，吝。（只與同宗族或小圈子交往，心胸狹隘，有憾）",
            3: "九三：伏戎于莽，升其高陵，三歲不興。（埋伏兵馬欲攻擊，但敵強我弱，久久不敢行動）",
            4: "九四：乘其墉，弗克攻，吉。（登上城牆準備攻擊，但發現不義而停止，困而知返吉）",
            5: "九五：同人，先號咷而後笑，大師克相遇。（歷經艱難波折，最終衝破阻礙而團聚，先苦後甜）",
            6: "上九：同人于郊，無悔。（在荒郊與人交往，遠離爭端，雖無大成但也無悔）"
        }
    },
    '離乾': {
        'num': 14,
        'name': '火天大有',
        'meaning': '元亨。',
        'fortune': '上上。如日中天，盛大豐有。事業運極佳，名利雙收，宜順天應人。',
        'lines': {
            1: "初九：無交害，匪咎，艱則無咎。（不相干涉，互不侵害，謹慎處事則無災）",
            2: "九二：大車以載，有攸往，無咎。（像大車一樣承載重任，任重道遠，前行無災）",
            3: "九三：公用亨于天子，小人弗克。（貢獻賢才或財物給天子，小人承擔不起這種重任）",
            4: "九四：匪其彭，無咎。（雖富有但不驕傲炫耀，謙虛謹慎，無災）",
            5: "六五：厥孚交如，威如，吉。（以誠信交往，不怒而威，吉利）",
            6: "上九：自天祐之，吉無不利。（順應天道，得到上天保佑，大吉大利）"
        }
    },
    '坤艮': {
        'num': 15,
        'name': '地山謙',
        'meaning': '亨，君子有終。',
        'fortune': '上上。易經中唯一六爻皆吉之卦。謙虛受益，滿招損。以退為進，大吉。',
        'lines': {
            1: "初六：謙謙君子，用涉大川，吉。（謙虛而又謙虛，修養極高，即使涉險也能獲吉）",
            2: "六二：鳴謙，貞吉。（名聲遠播仍保持謙虛，堅守正道吉）",
            3: "九三：勞謙君子，有終吉。（有功勞而謙虛，能善始善終，吉）",
            4: "六四：無不利，撝謙。（無往不利，發揮謙虛的美德）",
            5: "六五：不富以其鄰，利用侵伐，無不利。（雖不富有無權勢，但因謙德得鄰里支持，討伐不義無不利）",
            6: "上六：鳴謙，利用行師，征邑國。（謙虛之名遠揚，可用於出師平亂，治理封邑）"
        }
    },
    '震坤': {
        'num': 16,
        'name': '雷地豫',
        'meaning': '利建侯行師。',
        'fortune': '中平。安樂愉悅，順時而動。需防樂極生悲，不可沉溺逸樂。',
        'lines': {
            1: "初六：鳴豫，凶。（自鳴得意，驕傲放縱，凶）",
            2: "九二：介于石，不終日，貞吉。（像石頭一樣堅定，不沉溺享樂，堅守正道吉）",
            3: "六三：盱豫，悔。遲有悔。（巴結奉承以求安樂，會後悔。遲疑不決也會後悔）",
            4: "九四：由豫，大有得。勿疑，朋盍簪。（眾人賴以歡樂的中心，大有收穫，朋友如髮簪般匯聚）",
            5: "六五：貞疾，恆不死。（沉溺快樂導致疾病，雖不致死但長期未癒，需警惕）",
            6: "上六：冥豫，成有渝，無咎。（昏庸沉迷於享樂，若能及時改變，可免災禍）"
        }
    },
    '兌震': {
        'num': 17,
        'name': '澤雷隨',
        'meaning': '元亨利貞，無咎。',
        'fortune': '中上。隨順時勢，隨機應變。跟隨有德者，順其自然，不宜固執己見。',
        'lines': {
            1: "初九：官有渝，貞吉。出門交有功。（官職變動，堅守正道。出門廣結善緣則有功）",
            2: "六二：係小子，失丈夫。（在此處即抓住了小的，錯失了大的，眼光短淺）",
            3: "六三：係丈夫，失小子。隨有求得，利居貞。（追隨大人，捨棄小利。有所求必有所得，利於守正）",
            4: "九四：隨有獲，貞凶。有孚在道，以明，何咎。（隨順他人雖有收穫，但若有私心則凶。心存誠信光明，無災）",
            5: "九五：孚于嘉，吉。（把誠信帶給美好善良的人，吉利）",
            6: "上六：拘係之，乃從維之。王用亨于西山。（被迫跟隨，被繩索綑綁。君王在西山祭祀，誠心雖可感天，但處境被動）"
        }
    },
    '艮巽': {
        'num': 18,
        'name': '山風蠱',
        'meaning': '元亨，利涉大川。先甲三日，後甲三日。',
        'fortune': '中下。敗壞之象，內部腐化。需大刀闊斧整頓改革，振作精神可轉危為安。',
        'lines': {
            1: "初六：幹父之蠱，有子，考無咎，厲終吉。（繼承父業，整治弊病，雖有困難，最終吉利）",
            2: "九二：幹母之蠱，不可貞。（整治母系的弊病，不可太過強硬，宜柔順將就）",
            3: "九三：幹父之蠱，小有悔，無大咎。（整治父輩弊端，稍有悔恨，但無大災）",
            4: "六四：裕父之蠱，往見吝。（寬容父輩弊病而不整治，將來會陷入困境）",
            5: "六五：幹父之蠱，用譽。（整治父輩弊病，獲得讚譽）",
            6: "上九：不事王侯，高尚其事。（不侍奉王侯，超然物外，保持高尚的情操）"
        }
    },
    '坤兌': {
        'num': 19,
        'name': '地澤臨',
        'meaning': '元亨利貞。至於八月有凶。',
        'fortune': '中上。居高臨下，貴人來到。運勢轉強，但需注意好景不常，宜把握當下。',
        'lines': {
            1: "初九：咸臨，貞吉。（感應降臨，堅守正道吉）",
            2: "九二：咸臨，吉無不利。（感應降臨，吉利，無所不利）",
            3: "六三：甘臨，無攸利。既憂之，無咎。（用甜言蜜語誘人，無利。若能憂慮改過，無災）",
            4: "六四：至臨，無咎。（親自蒞臨，平易近人，無災）",
            5: "六五：知臨，大君之宜，吉。（以智慧降臨，順應賢能，這是君主的合宜之道，吉）",
            6: "上六：敦臨，吉無咎。（敦厚誠懇地降臨，吉利無災）"
        }
    },
    '巽坤': {
        'num': 20,
        'name': '風地觀',
        'meaning': '盥而不薦，有孚顒若。',
        'fortune': '中平。觀察瞻仰，等待時機。宜靜觀其變，多看少做，自我反省。',
        'lines': {
            1: "初六：童觀，小人無咎，君子吝。（像孩童一樣見識淺薄，對常人無礙，對君子則為憾事）",
            2: "六二：闚觀，利女貞。（從門縫偷看，視野狹窄，適合女子堅守正道，不利君子）",
            3: "六三：觀我生，進退。（觀察自己的行為與處境，來決定進退）",
            4: "六四：觀國之光，利用賓于王。（觀察國家的光輝盛況，利於成為君王的賓客，出仕任官）",
            5: "九五：觀我生，君子無咎。（身居高位，觀察自己的行為影響，君子無災）",
            6: "上九：觀其生，君子無咎。（觀察眾生的生存狀態，君子無災）"
        }
    },
    
    # 第21-30卦
    '離震': {
        'num': 21,
        'name': '火雷噬嗑',
        'meaning': '亨。利用獄。',
        'fortune': '中平。咬合咀嚼，除舊佈新。雖有障礙，但透過果斷行動與刑罰（紀律），終能亨通。',
        'lines': {
            1: "初九：屨校滅趾，無咎。（腳上戴著刑具，遮蓋了腳趾，小懲大誡，不會再犯錯，無災）",
            2: "六二：噬膚滅鼻，無咎。（咬軟肉咬到掩住鼻子，雖用力過猛，但處置得當，無災）",
            3: "六三：噬臘肉，遇毒。小吝，無咎。（咬乾硬的臘肉遇到毒，雖有小麻煩，但最終無災）",
            4: "九四：噬乾胏，得金矢。利艱貞，吉。（咬帶骨頭的乾肉，發現金箭頭，雖艱難但堅守正道則吉）",
            5: "六五：噬乾肉，得黃金。貞厲，無咎。（咬乾肉得到黃金，雖有危險，但堅守正道無災）",
            6: "上九：何校滅耳，凶。（肩上扛著大枷鎖遮住耳朵，罪惡深重聽不進勸告，凶）"
        }
    },
    '艮離': {
        'num': 22,
        'name': '山火賁',
        'meaning': '亨。小利有攸往。',
        'fortune': '中上。裝飾美化，文飾外表。適合小事，大事不宜過度依賴外表，需重實質。',
        'lines': {
            1: "初九：賁其趾，捨車而徒。（修飾腳趾，捨棄車馬徒步而行，安貧樂道）",
            2: "六二：賁其鬚。（修飾鬍鬚，順應長者，隨勢而為）",
            3: "九三：賁如濡如，永貞吉。（裝飾得光澤亮麗，長久堅守正道吉）",
            4: "六四：賁如皤如，白馬翰翰。匪寇婚媾。（素雅裝飾，白馬飛馳。不是強盜，是來求婚的，吉）",
            5: "六五：賁于丘園，束帛戔戔，吝，終吉。（在山林園圃中裝飾，禮物雖微薄但心意誠摯，雖有憾終吉）",
            6: "上九：白賁，無咎。（回歸簡約素雅，不加裝飾的本色，無災）"
        }
    },
    '艮坤': {
        'num': 23,
        'name': '山地剝',
        'meaning': '不利有攸往。',
        'fortune': '下下。剝落腐蝕，小人當道。基礎動搖，不利前往，宜謹慎防守，等待時機。',
        'lines': {
            1: "初六：剝床以足，蔑貞凶。（像床腳開始腐朽，根基被破壞，凶）",
            2: "六二：剝床以辨，蔑貞凶。（床幹也被侵蝕，危機逼近，凶）",
            3: "六三：剝之，無咎。（雖在剝落之時，但因與君子相應，可免災禍）",
            4: "六四：剝床以膚，凶。（災禍已逼近身體，迫在眉睫，凶）",
            5: "六五：貫魚，以宮人寵，無不利。（像串魚一樣依序受寵，率眾歸順君子，無不利）",
            6: "上九：碩果不食，君子得輿，小人剝廬。（碩果僅存，亂世將盡，君子得民心，小人將自毀家園）"
        }
    },
    '坤震': {
        'num': 24,
        'name': '地雷復',
        'meaning': '亨。出入無疾，朋來無咎。反復其道，七日來復，利有攸往。',
        'fortune': '中上。一陽來復，萬物更新。剝極必復，低谷回升，適合開始新計畫。',
        'lines': {
            1: "初九：不遠復，無祇悔，元吉。（迷途不遠即知返，沒有大悔恨，大吉）",
            2: "六二：休復，吉。（美好地回歸正道，吉利）",
            3: "六三：頻復，厲，無咎。（屢錯屢改，眉頭深鎖，雖有危險但最終無災）",
            4: "六四：中行獨復。（在群陰中獨自回歸正道，特立獨行）",
            5: "六五：敦復，無悔。（敦厚誠懇地反省回歸，無悔恨）",
            6: "上六：迷復，凶，有災眚。用行師，終有大敗。（執迷不悟，錯過回歸機會，凶。若用兵必大敗）"
        }
    },
    '乾震': {
        'num': 25,
        'name': '天雷無妄',
        'meaning': '元亨利貞。其匪正有眚，不利有攸往。',
        'fortune': '中平。真實無虛，順其自然。不可妄動，若心術不正或輕舉妄動必招災禍。',
        'lines': {
            1: "初九：無妄，往吉。（心懷誠信，不存虛妄，前行吉利）",
            2: "六二：不耕獲，不菑亞，則利有攸往。（不存非分之想，不求意外收穫，腳踏實地則利）",
            3: "六三：無妄之災，或繫之牛，行人之得，邑人之災。（意外的災禍，路人牽走牛，村民卻被懷疑偷竊）",
            4: "九四：可貞，無咎。（堅守正道，保持純正，無災）",
            5: "九五：無妄之疾，勿藥有喜。（意外得病，不需亂吃藥，自然會痊癒）",
            6: "上九：無妄，行有眚，無攸利。（雖然無妄，但時機不對，行動會出錯，無利）"
        }
    },
    '艮乾': {
        'num': 26,
        'name': '山天大畜',
        'meaning': '利貞，不家食吉，利涉大川。',
        'fortune': '上上。積聚德行，大有儲蓄。才華受重用，不需在家吃閒飯，利於冒險犯難。',
        'lines': {
            1: "初九：有厲，利已。（有危險，適時停止不前是有利的）",
            2: "九二：輿說輻。（車輪脫落，主動停止行動，順勢而為）",
            3: "九三：良馬逐，利艱貞。日閑輿衛，利有攸往。（良馬奔馳，艱苦磨練。每日訓練車馬防衛，利於前行）",
            4: "六四：童牛之牿，元吉。（給小牛角裝上護木，防患於未然，大吉）",
            5: "六五：豶豕之牙，吉。（閹割野豬使其馴服，從根本消除危害，吉）",
            6: "上九：何天之衢，亨。（道通天際，暢行無阻，大亨通）"
        }
    },
    '艮震': {
        'num': 27,
        'name': '山雷頤',
        'meaning': '貞吉。觀頤，自求口實。',
        'fortune': '中平。頤養之道，禍從口出。注意飲食健康與言語謹慎，自食其力。',
        'lines': {
            1: "初九：捨爾靈龜，觀我朵頤，凶。（捨棄自己的靈龜智慧，羨慕別人的口腹之慾，凶）",
            2: "六二：顛頤，拂經，于丘頤，征凶。（顛倒養育之道，違背常理，向地位高者求食，出征凶）",
            3: "六三：拂頤，貞凶，十年勿用，無攸利。（違背養育正道，凶，長期不可重用，無利）",
            4: "六四：顛頤，吉，虎視眈眈，其欲逐逐，無咎。（雖顛倒求養，但專注如虎視，追求賢才，無災吉）",
            5: "六五：拂經，居貞吉，不可涉大川。（雖違常理，但居位守正吉，不宜冒險）",
            6: "上九：由頤，厲吉，利涉大川。（天下皆由其養育，雖任重道遠有險，但吉，利於大事）"
        }
    },
    '兌巽': {
        'num': 28,
        'name': '澤風大過',
        'meaning': '棟橈，利有攸往，亨。',
        'fortune': '下下（或中下）。壓力過大，棟梁彎曲。非常時期，需非常手段，獨立支撐可成事。',
        'lines': {
            1: "初六：藉用白茅，無咎。（極度謹慎，用白茅墊底，無災）",
            2: "九二：枯楊生稊，老夫得其女妻，無不利。（枯楊發芽，老夫娶少妻，雖異常但無不利）",
            3: "九三：棟橈，凶。（棟梁彎曲，無法支撐，凶）",
            4: "九四：棟隆，吉，有它吝。（棟梁隆起，能支撐重任，吉。若有雜念則有憾）",
            5: "九五：枯楊生華，老婦得其士夫，無咎無譽。（枯楊開花，曇花一現，老婦嫁少夫，無災也無榮譽）",
            6: "上六：過涉滅頂，凶，無咎。（涉水過深致滅頂，凶。但因捨身取義，道義上無咎）"
        }
    },
    '坎坎': {
        'num': 29,
        'name': '坎為水',
        'meaning': '習坎，有孚，維心亨，行有尚。',
        'fortune': '下下。重重險阻，困難重重。需堅守信念，行事謹慎，不可輕舉妄動。',
        'lines': {
            1: "初六：習坎，入于坎窞，凶。（險上加險，落入深坑，凶）",
            2: "九二：坎有險，求小得。（處在險境，只求微小的收穫，不可貪多）",
            3: "六三：來之坎坎，險且枕，入于坎窞，勿用。（進退皆險，枕戈待旦，陷入深淵，不可妄動）",
            4: "六四：樽酒簋貳，用缶，納約自牖，終無咎。（簡約祭祀，誠心從窗戶溝通，最終無災）",
            5: "九五：坎不盈，祗既平，無咎。（水未滿溢，險難將平，無災）",
            6: "上六：係用徽纆，寘于叢棘，三歲不得，凶。（被繩索綑綁，囚禁在荊棘中，三年不得釋放，凶）"
        }
    },
    '離離': {
        'num': 30,
        'name': '離為火',
        'meaning': '利貞，亨。畜牝牛，吉。',
        'fortune': '中上。光明普照，附麗依託。如火需附木，宜依附正道或貴人，柔順者吉。',
        'lines': {
            1: "初九：履錯然，敬之，無咎。（腳步錯雜，需恭敬謹慎，無災）",
            2: "六二：黃離，元吉。（依附中正之道，如黃色光輝，大吉）",
            3: "九三：日昃之離，不鼓缶而歌，則大耋之嗟，凶。（夕陽西下，應及時行樂或安天命，若只知感嘆衰老則凶）",
            4: "九四：突如其來如，焚如，死如，棄如。（突然爆發，如烈火焚燒，帶來毀滅，凶）",
            5: "六五：出涕沱若，戚嗟若，吉。（憂患意識深重，淚流滿面，反而能化險為夷，吉）",
            6: "上九：王用出征，有嘉折首，獲匪其醜，無咎。（君王出征，斬殺首領，不殺脅從者，無災）"
        }
    },
    
    # 第31-40卦
    '兌艮': {
        'num': 31,
        'name': '澤山咸',
        'meaning': '亨，利貞，取女吉。',
        'fortune': '中上。感應溝通，心心相印。適合感情婚戀，人際關係和諧，做事順遂。',
        'lines': {
            1: "初六：咸其拇。（感應發生在腳趾，情感萌動之初，尚未行動）",
            2: "六二：咸其腓，凶，居吉。（感應發生在小腿，躁動不安，凶。若能安分守己則吉）",
            3: "九三：咸其股，執其隨，往吝。（感應在大腿，盲目隨波逐流，缺乏主見，前行有憾）",
            4: "九四：貞吉，悔亡。憧憧往來，朋從爾思。（堅守正道吉。若心意不定、患得患失，則只有朋友順從你的想法，無法感通天下）",
            5: "九五：咸其脢，無悔。（感應發生在脊背，雖無法深層感通，但也沒有悔恨）",
            6: "上六：咸其輔頰舌。（感應只在嘴巴舌頭，花言巧語，缺乏誠意）"
        }
    },
    '震巽': {
        'num': 32,
        'name': '雷風恆',
        'meaning': '亨，無咎，利貞，利有攸往。',
        'fortune': '中上。恆久不變，持之以恆。適合長期計畫、婚姻維持，忌半途而廢或朝令夕改。',
        'lines': {
            1: "初六：浚恆，貞凶，無攸利。（求恆心切，掘地太深，欲速則不達，凶）",
            2: "九二：悔亡。（堅守中庸之道，悔恨消失）",
            3: "九三：不恆其德，或承之羞，貞吝。（德行不穩定，反反覆覆，會招致羞辱）",
            4: "九四：田無禽。（久獵無功，位置不當，徒勞無獲）",
            5: "六五：恆其德，貞，婦人吉，夫子凶。（恆守婦道順從，女子吉；男子應剛健進取，若只知順從則凶）",
            6: "上六：振恆，凶。（動盪不穩，失去恆心，大凶）"
        }
    },
    '乾艮': {
        'num': 33,
        'name': '天山遯',
        'meaning': '亨，小利貞。',
        'fortune': '下下（或中平）。退避隱居，急流勇退。小人勢長，君子宜避其鋒芒，不宜硬碰硬。',
        'lines': {
            1: "初六：遯尾，厲，勿用有攸往。（處於退避的尾端，落後危險，不宜有所行動）",
            2: "六二：執之用黃牛之革，莫之勝說。（像用黃牛皮繩綑綁一樣，意志堅定，無法動搖）",
            3: "九三：係遯，有疾厲，畜臣妾吉。（想退卻被牽絆，如疾在身。此時僅利於安置僕妾等小事）",
            4: "九四：好遯，君子吉，小人否。（君子能瀟灑退隱，吉；小人依戀名利，做不到）",
            5: "九五：嘉遯，貞吉。（完美地退隱，合乎正道，吉利）",
            6: "上九：肥遯，無不利。（遠走高飛，退得從容自在，無不利）"
        }
    },
    '震乾': {
        'num': 34,
        'name': '雷天大壯',
        'meaning': '利貞。',
        'fortune': '中上。聲勢壯大，氣勢如虹。但切忌恃強凌弱、衝動魯莽，宜守正道。',
        'lines': {
            1: "初九：壯于趾，征凶，有孚。（僅有腳趾壯大，力量在底層，強行出征凶）",
            2: "九二：貞吉。（堅守中正之道，吉利）",
            3: "九三：小人用壯，君子用罔，貞厲。羝羊觸藩，羸其角。（小人恃強，君子忽視力量。像公羊撞籬笆，卡住角，處境尷尬）",
            4: "九四：貞吉，悔亡。藩決不羸，壯于大輿之輹。（堅守正道，衝破藩籬，如大車輪軸般強壯，吉）",
            5: "六五：喪羊于易，無悔。（在牧場走失了羊，雖有小失，但無大悔）",
            6: "上六：羝羊觸藩，不能退，不能遂，無攸利，艱則吉。（公羊角卡在籬笆，進退兩難。需忍耐堅持，度過難關則吉）"
        }
    },
    '離坤': {
        'num': 35,
        'name': '火地晉',
        'meaning': '康侯用錫馬蕃庶，晝日三接。',
        'fortune': '上上。旭日東昇，步步高升。受上司賞識，晉升有望，宜積極進取。',
        'lines': {
            1: "初六：晉如，摧如，貞吉。罔孚，裕無咎。（晉升受阻，被排擠，堅守正道吉。雖未被信任，但寬容自處無災）",
            2: "六二：晉如，愁如，貞吉。受茲介福，于其王母。（雖晉升受阻而憂愁，但堅守正道，終獲太后賜福）",
            3: "六三：眾允，悔亡。（獲得眾人信任與支持，悔恨消失）",
            4: "九四：晉如鼫鼠，貞厲。（像鼫鼠一樣貪婪地晉升，位置不正，即使守正也有危險）",
            5: "六五：悔亡，失得勿恤，往吉，無不利。（悔恨消失，不計較得失，勇往直前，大吉）",
            6: "上九：晉其角，維用伐邑，厲吉，無咎，貞吝。（晉升到頂端，鑽牛角尖。若用於征伐屬地可獲吉，但若堅持不變則有憾）"
        }
    },
    '坤離': {
        'num': 36,
        'name': '地火明夷',
        'meaning': '利艱貞。',
        'fortune': '下下。光明受損，晦暗不明。才華被埋沒，環境艱難，宜韜光養晦，不可強出頭。',
        'lines': {
            1: "初九：明夷于飛，垂其翼。君子于行，三日不食，有攸往，主人有言。（鳥在飛翔中被傷翼，君子逃難，歷盡艱辛，受人非議）",
            2: "六二：明夷，夷于左股，用拯馬壯，吉。（左腿受傷，幸有強壯的馬匹搭救，吉）",
            3: "九三：明夷于南狩，得其大首，不可疾貞。（在南方狩獵，抓獲罪魁禍首，但不可操之過急）",
            4: "六四：入于左腹，獲明夷之心，于出門庭。（深入敵營腹地，洞悉其心意，然後全身而退）",
            5: "六五：箕子之明夷，利貞。（像箕子一樣裝瘋賣傻，忍辱負重，堅守正道）",
            6: "上六：不明晦，初登于天，後入于地。（完全黑暗，先是高高在上，最終跌入深淵，自取滅亡）"
        }
    },
    '巽離': {
        'num': 37,
        'name': '風火家人',
        'meaning': '利女貞。',
        'fortune': '中上。家庭和睦，內助之賢。女主內男主外，各司其職，家和萬事興。',
        'lines': {
            1: "初九：閑有家，悔亡。（治家初起就設立規矩防範，悔恨消失）",
            2: "六二：無攸遂，在中饋，貞吉。（不隨意追求外面的成就，專心主持家務，堅守正道吉）",
            3: "九三：家人嗃嗃，悔厲吉；婦子嘻嘻，終吝。（治家嚴厲雖有怨言，但終吉；若嘻笑隨便，最終會有憾）",
            4: "六四：富家，大吉。（使家庭富足，大吉大利）",
            5: "九五：王假有家，勿恤吉。（君王以身作則治理好家庭，推己及人，不用憂慮，吉）",
            6: "上九：有孚威如，終吉。（誠信莊重，有威嚴，最終吉利）"
        }
    },
    '離兌': {
        'num': 38,
        'name': '火澤睽',
        'meaning': '小事吉。',
        'fortune': '下下（或中下）。背道而馳，意見不合。人際疏離，矛盾衝突，只能做小事，大事難成。',
        'lines': {
            1: "初九：悔亡，喪馬勿逐，自復；見惡人，無咎。（悔恨消失，馬丟了不用追，會自己回來；不得不見惡人，無災）",
            2: "九二：遇主于巷，無咎。（在小巷中巧遇主人，雖然非正式場合，但得以溝通，無災）",
            3: "六三：見輿曳，其牛掣，其人天且劓，無初有終。（車被拖住，牛被拉回，人受刑毀容，過程雖慘，結局尚可）",
            4: "九四：睽孤，遇元夫，交孚，厲無咎。（孤立無援，遇到剛陽的貴人，誠信相交，化險為夷）",
            5: "六五：悔亡，厥宗噬膚，往何咎。（悔恨消失，宗族如咬軟肉般容易地團結在一起，前行無災）",
            6: "上九：睽孤，見豕負塗，載鬼一車，先張之弧，後說之弧，匪寇婚媾，往遇雨則吉。（疑神疑鬼，看人像鬼。後放下猜疑，冰釋前嫌，如遇雨過天晴般吉利）"
        }
    },
    '坎艮': {
        'num': 39,
        'name': '水山蹇',
        'meaning': '利西南，不利東北。利見大人，貞吉。',
        'fortune': '下下。寸步難行，前有險阻。不宜冒進，宜退守等待救援或尋求貴人幫助。',
        'lines': {
            1: "初六：往蹇，來譽。（前往艱難，退回來會得到讚譽，明哲保身）",
            2: "六二：王臣蹇蹇，匪躬之故。（臣子為了君王歷經艱險，不是為了自己，忠心可嘉）",
            3: "九三：往蹇，來反。（前往艱難，不如退回來，重整旗鼓）",
            4: "六四：往蹇，來連。（前往艱難，回來能連結眾人力量）",
            5: "九五：大蹇，朋來。（處於極大艱難中，但有朋友相助，共渡難關）",
            6: "上六：往蹇，來碩，吉，利見大人。（前往艱難，回來有大收穫。吉，利於尋求貴人）"
        }
    },
    '震坎': {
        'num': 40,
        'name': '雷水解',
        'meaning': '利西南。無所往，其來復吉。有攸往，夙吉。',
        'fortune': '中上。困難解除，雨過天晴。若無事則休養生息，若有事則宜速戰速決。',
        'lines': {
            1: "初六：無咎。（困難剛解，安分守己，無災）",
            2: "九二：田獲三狐，得黃矢，貞吉。（打獵捕獲三隻狐狸，獲得黃金箭頭。除去小人，堅守正道吉）",
            3: "六三：負且乘，致寇至，貞吝。（小人背著重物又乘車，身分不配，招搖過市引來強盜，羞恥）",
            4: "九四：解而拇，朋至斯孚。（解開腳拇指的羈絆，斷絕與小人的往來，誠信的朋友就會到來）",
            5: "六五：君子維有解，吉，有孚于小人。（君子能解開小人的束縛，感化或驅逐之，吉）",
            6: "上六：公用射隼于高墉之上，獲之，無不利。（在高牆上射中惡鳥，除惡務盡，無所不利）"
        }
    },
    
    # 第41-50卦
    '艮兌': {
        'num': 41,
        'name': '山澤損',
        'meaning': '有孚，元吉，無咎，可貞，利有攸往。曷之用，二簋可用享。',
        'fortune': '中平。減損、犧牲。損下益上，為了長遠利益暫時犧牲小我。先難後易。',
        'lines': {
            1: "初九：已事遄往，無咎，酌損之。（停下自己的事趕去助人，無災。要量力而為）",
            2: "九二：利貞，征凶，弗損益之。（堅守正道吉，主動出擊凶。不需自我減損就能益人）",
            3: "六三：三人行則損一人，一人行則得其友。（三人同行必有紛爭，專一獨行反能得志同道合之友）",
            4: "六四：損其疾，使遄有喜，無咎。（減損自身的缺點毛病，趕快改過會有喜事，無災）",
            5: "六五：或益之，十朋之龜弗克違，元吉。（會有巨大的幫助降臨，價值連城，天意如此，大吉）",
            6: "上九：弗損益之，無咎，貞吉，利有攸往，得臣無家。（不減損自己也能造福他人，吉。惠而不費，格局宏大）"
        }
    },
    '巽震': {
        'num': 42,
        'name': '風雷益',
        'meaning': '利有攸往，利涉大川。',
        'fortune': '上上。增益、獲利。損上益下，施惠於人。運勢強盛，適合大展宏圖。',
        'lines': {
            1: "初九：利用為大作，元吉，無咎。（利用好時機做大事，大吉大利，無災）",
            2: "六二：或益之，十朋之龜弗克違，永貞吉。（獲得極大的幫助，堅持正道則長久吉利）",
            3: "六三：益之用凶事，無咎。有孚中行，告公用圭。（在危難中得到幫助，無災。誠信行事，向王公求援）",
            4: "六四：中行，告公從。利用為依遷國。（行事中正，建議會被上級採納。利於依附強者或遷徙）",
            5: "九五：有孚惠心，勿問元吉。有孚惠我德。（心懷誠信施惠於人，不必占卜也是大吉。眾人會感念恩德）",
            6: "上九：莫益之，或擊之，立心勿恆，凶。（沒人幫你，甚至有人攻擊你。因為貪得無厭且心志不恆，凶）"
        }
    },
    '兌乾': {
        'num': 43,
        'name': '澤天夬',
        'meaning': '揚于王庭，孚號，有厲，告自邑，不利即戎，利有攸往。',
        'fortune': '中上（或險）。決斷、決裂。五陽除一陰，勢不可擋，但需防小人反撲，不可動武，宜公開揭露。',
        'lines': {
            1: "初九：壯于前趾，往不勝為咎。（腳趾剛動就想前進，力量不足，前往必敗）",
            2: "九二：惕號，莫夜有戎，勿恤。（時刻警惕驚呼，防備夜間突襲，以此心態則不必擔憂）",
            3: "九三：壯于頄，有凶。君子夬夬，獨行遇雨，若濡有慍，無咎。（怒形於色，有凶。君子決斷果決，雖被誤解如淋濕般狼狽，但終無災）",
            4: "九四：臀無膚，其行次且。牽羊悔亡，聞言不信。（坐立難安，前行蹣跚。若能像羊一樣順從牽引則悔恨消，但可惜聽不進勸）",
            5: "九五：莧陸夬夬，中行無咎。（像切斷莧菜一樣果斷地解決小人，行事中正無災）",
            6: "上六：無號，終有凶。（無法號召同伴，孤立無援，最終凶）"
        }
    },
    '乾巽': {
        'num': 44,
        'name': '天風姤',
        'meaning': '女壯，勿用取女。',
        'fortune': '中平。相遇、邂逅。陰長陽消，不期而遇。女子強勢，不宜娶妻，需防桃花劫或小人侵凌。',
        'lines': {
            1: "初六：繫于金柅，貞吉，有攸往，見凶，羸豕孚蹢躅。（像被金屬車閘煞住，安分則吉，妄動則凶。小人如瘦豬般躁動）",
            2: "九二：包有魚，無咎，不利賓。（廚房有魚，自己享用無災，不宜拿去宴請賓客，意指控制住小人）",
            3: "九三：臀無膚，其行次且，厲，無大咎。（坐立難安，行走困難，雖有危險但無大災）",
            4: "九四：包無魚，起凶。（廚房沒魚，機會流失，凶）",
            5: "九五：以杞包瓜，含章，有隕自天。（用杞柳葉包住瓜果，內斂文采，天上掉下來的運氣）",
            6: "上九：姤其角，吝，無咎。（頭上長角，性格孤僻難相處，雖有憾但無大災）"
        }
    },
    '兌坤': {
        'num': 45,
        'name': '澤地萃',
        'meaning': '亨。王假有廟，利見大人，亨，利貞。用大牲吉，利有攸往。',
        'fortune': '上上。聚集、薈萃。人才物資聚集，繁榮昌盛。利於祭祀、會見大人物。',
        'lines': {
            1: "初六：有孚不終，乃亂乃萃，若號一握為笑，勿恤，往無咎。（誠信不足，聚散無常。若能號召眾人握手言和，則不必擔憂）",
            2: "六二：引吉，無咎，孚乃利用禴。（被牽引而來，吉。只要有誠信，微薄的祭品也能感動神靈）",
            3: "六三：萃如，嗟如，無攸利，往無咎，小吝。（想聚集卻聚不起來，嘆息，無利。前往無災，但有小憾）",
            4: "九四：大吉，無咎。（大吉大利，無災）",
            5: "九五：萃有位，無咎。匪孚，元永貞，悔亡。（身居高位聚集眾人，無災。若未獲信任，需長久修德，悔恨才會消失）",
            6: "上六：齎咨涕洟，無咎。（悲傷嘆息，淚流滿面，雖憂慮但無大災，示警之意）"
        }
    },
    '坤巽': {
        'num': 46,
        'name': '地風升',
        'meaning': '元亨，用見大人，勿恤，南征吉。',
        'fortune': '上上。上升、晉升。如樹木生長，積小成大。利於求見貴人，向南發展吉。',
        'lines': {
            1: "初六：允升，大吉。（獲得信任而晉升，大吉）",
            2: "九二：孚乃利用禴，無咎。（有誠信，即使祭品微薄也能獲福，無災）",
            3: "九三：升虛邑。（晉升到無人的空城，如入無人之境，毫無阻礙）",
            4: "六四：王用亨于岐山，吉，無咎。（君王在岐山祭祀，誠心獲福，吉）",
            5: "六五：貞吉，升階。（堅守正道吉，步步高升，拾級而上）",
            6: "上六：冥升，利于不息之貞。（在昏暗中仍盲目上升，只有堅持正道才能獲利，否則迷失）"
        }
    },
    '兌坎': {
        'num': 47,
        'name': '澤水困',
        'meaning': '亨，貞，大人吉，無咎，有言不信。',
        'fortune': '下下。困窮、受困。水澤乾涸，窮困之境。此時多說無益，宜沈潛忍耐，等待時機。',
        'lines': {
            1: "初六：臀困于株木，入于幽谷，三歲不覿。（坐困在枯木樁上，逃入幽深山谷，三年不見天日）",
            2: "九二：困于酒食，朱紱方來，利用享祀，征凶，無咎。（被酒食宴樂所困，雖有官服加身，但出征凶，只宜祭祀求福）",
            3: "六三：困于石，據于蒺藜，入于其宮，不見其妻，凶。（被困在亂石中，依靠在荊棘上，回到家看不見妻子，凶）",
            4: "九四：來徐徐，困于金車，吝，有終。（救兵來得慢，被豪華金車阻隔，雖有憾但最終能解困）",
            5: "九五：劓刖，困于赤紱，乃徐有說，利用祭祀。（受刑罰之辱，被官職所困，慢慢解脫，利於祭祀祈禱）",
            6: "上六：困于葛藟，于臲卼，曰動悔。有悔，征吉。（被藤蔓纏繞，動盪不安。若能悔悟並採取行動，出征吉）"
        }
    },
    '坎巽': {
        'num': 48,
        'name': '水風井',
        'meaning': '改邑不改井，無喪無得，往來井井。汔至，亦未繘井，羸其瓶，凶。',
        'fortune': '中平。養人、資源。井水養人，取之不盡。強調維護與共享，若水瓶破裂則前功盡棄。',
        'lines': {
            1: "初六：井泥不食，舊井無禽。（井底淤泥，水不可食，連鳥都不來）",
            2: "九二：井谷射鮒，甕敝漏。（井底有積水可抓魚，但水甕破漏裝不住水，無用）",
            3: "九三：井渫不食，為我心惻，可用汲，王明，並受其福。（井水淘乾淨了卻沒人喝，令人心傷。若遇明君，定能受福）",
            4: "六四：井甃，無咎。（修砌井壁，維護修繕，無災）",
            5: "九五：井冽，寒泉食。（井水清澈，甘甜清涼可供飲用，大功告成）",
            6: "上六：井收勿幕，有孚元吉。（井口不加蓋，任人汲取，誠信養人，大吉）"
        }
    },
    '兌離': {
        'num': 49,
        'name': '澤火革',
        'meaning': '已日乃孚，元亨利貞，悔亡。',
        'fortune': '中上（變動）。變革、革命。水火不容，勢在必行。時機成熟才能改革，需順乎天而應乎人。',
        'lines': {
            1: "初九：鞏用黃牛之革。（用黃牛皮繩綑綁牢固，時機未到，暫時按兵不動）",
            2: "六二：已日乃革之，征吉，無咎。（時機已到，可以進行變革，出征吉，無災）",
            3: "九三：征凶，貞厲，革言三就，有孚。（躁進出征凶。要經過多次討論審議，取得信任後才能變革）",
            4: "九四：悔亡，有孚改命，吉。（悔恨消失，心懷誠信去改革天命，吉）",
            5: "九五：大人虎變，未占有孚。（偉大人物的變革如猛虎換毛般煥然一新，不必占卜也知眾人信服）",
            6: "上六：君子豹變，小人革面，征凶，居貞吉。（君子如豹變般文采斐然，小人僅表面改變。此時再激進則凶，守成則吉）"
        }
    },
    '離巽': {
        'num': 50,
        'name': '火風鼎',
        'meaning': '元吉，亨。',
        'fortune': '上上。取新、穩重。去舊立新，除故布新。象徵穩重圖變，三人成行，大吉大利。',
        'lines': {
            1: "初六：鼎顛趾，利出否，得妾以其子，無咎。（鼎腳顛倒，倒出髒東西，利於除舊。如得妾生子，無災）",
            2: "九二：鼎有實，我仇有疾，不我能即，吉。（鼎中充滿食物，遭小人嫉妒，但對方無法傷害我，吉）",
            3: "九三：鼎耳革，其行塞，雉膏不食，方雨虧悔，終吉。（鼎耳損壞無法移動，美味吃不到。待陰陽調和，悔恨消除，終吉）",
            4: "九四：鼎折足，覆公餗，其形渥，凶。（鼎腳折斷，打翻了王公的美食，弄得滿地狼藉，凶）",
            5: "六五：鼎黃耳金鉉，利貞。（鼎配上黃耳金杠，中正尊貴，利於堅守正道）",
            6: "上九：鼎玉鉉，大吉，無不利。（鼎配上玉製的杠，溫潤剛毅，大吉，無所不利）"
        }
    },
    
    # 第51-64卦
    '震震': {
        'num': 51,
        'name': '震為雷',
        'meaning': '亨。震來虩虩，笑言啞啞。驚百里，不喪匕鬯。',
        'fortune': '中平（或虛驚）。震驚、動盪。局勢變動劇烈，先是恐懼，後因處變不驚而轉危為安。',
        'lines': {
            1: "初九：震來虩虩，後笑言啞啞，吉。（震驚來襲時恐懼，事後談笑風生，吉）",
            2: "六二：震來厲，億喪貝，躋于九陵，勿逐，七日得。（震盪危險，損失財物，跑去高山避難。不用追尋，七天後失物復得）",
            3: "六三：震蘇蘇，震行無眚。（震驚得驚慌失措，若能謹慎行動則無災）",
            4: "九四：震遂泥。（震驚墜入泥淖，無法動彈，志氣消沉）",
            5: "六五：震往來厲，億無喪，有事。（震盪往來危險，雖有損失但無大礙，依然能祭祀守成）",
            6: "上六：震索索，視矍矍，征凶。震不于其躬，于其鄰，無咎。婚媾有言。（恐懼發抖，目光游移，出征凶。災禍未及身時就該警惕，無災）"
        }
    },
    '艮艮': {
        'num': 52,
        'name': '艮為山',
        'meaning': '艮其背，不獲其身，行其庭，不見其人，無咎。',
        'fortune': '中平。靜止、停止。宜靜不宜動，安守本分，自我反省。',
        'lines': {
            1: "初六：艮其趾，無咎，利永貞。（控制腳步不妄動，無災，利於長久堅守正道）",
            2: "六二：艮其腓，不拯其隨，其心不快。（腿部想停，但無法控制大腿，想救人卻力不從心，心中不快）",
            3: "九三：艮其限，列其夤，厲薰心。（強行停止在腰部，導致脊背斷裂般痛苦，危險燒心）",
            4: "六四：艮其身，無咎。（止住身體不動，潔身自好，無災）",
            5: "六五：艮其輔，言有序，悔亡。（管住嘴巴，說話有條理，悔恨消失）",
            6: "上九：敦艮，吉。（敦厚篤實地靜止，修養到家，吉）"
        }
    },
    '巽艮': {
        'num': 53,
        'name': '風山漸',
        'meaning': '女歸吉，利貞。',
        'fortune': '上上。循序漸進，穩步高升。切忌急躁，按部就班則萬事可成，適合嫁娶。',
        'lines': {
            1: "初六：鴻漸于干，小子厲，有言，無咎。（鴻雁飛到水岸，小鳥有危險，被言語中傷，但無大災）",
            2: "六二：鴻漸于磐，飲食衎衎，吉。（鴻雁飛到磐石上，安穩地飲食快樂，吉）",
            3: "九三：鴻漸于陸，夫征不復，婦孕不育，凶；利禦寇。（鴻雁飛到陸地，丈夫出征不回，妻子懷孕流產，凶；利於防禦強盜）",
            4: "六四：鴻漸于木，或得其桷，無咎。（鴻雁飛到樹上，找到平柯棲息，無災）",
            5: "九五：鴻漸于陵，婦三歲不孕，終莫之勝，吉。（鴻雁飛到丘陵，夫婦分離三年不孕，但最終無人能阻擋團聚，吉）",
            6: "上九：鴻漸于陸，其羽可用為儀，吉。（鴻雁飛越雲霄，羽毛可做儀仗，志向高遠，吉）"
        }
    },
    '震兌': {
        'num': 54,
        'name': '雷澤歸妹',
        'meaning': '征凶，無攸利。',
        'fortune': '下下。名不順言不順，感情衝動。違反禮制常規，如飛蛾撲火，結局多不佳。',
        'lines': {
            1: "初九：歸妹以娣，跛能履，征吉。（嫁女時陪嫁娣妾，雖地位低如跛者行，但安守本分吉）",
            2: "九二：眇能視，利幽人的貞。（雖視力不佳但能看，利於在此時堅守貞靜之道）",
            3: "六三：歸妹以須，反歸以娣。（急於出嫁而被拒，只好回去做陪嫁，地位低微）",
            4: "九四：歸妹愆期，遲歸有時。（錯過婚期，雖晚嫁，但終有歸宿）",
            5: "六五：帝乙歸妹，其君之袂，不如其娣之袂良，月幾望，吉。（帝乙嫁妹，正室衣著不如陪嫁華麗，但德行如滿月般圓滿，吉）",
            6: "上六：女承筐無實，士刲羊無血，無攸利。（女捧空籃，男殺羊無血，虛有其表，婚事不成，無利）"
        }
    },
    '震離': {
        'num': 55,
        'name': '雷火豐',
        'meaning': '亨，王假之，勿憂，宜日中。',
        'fortune': '中上（盛極）。豐大盛滿，如日中天。成就巨大，但需防物極必反，好景恐不長。',
        'lines': {
            1: "初九：遇其配主，雖旬無咎，往有尚。（遇到匹配的主人，雖然僅十日之緣，但無災，前往受推崇）",
            2: "六二：豐其蔀，日中見斗，往得疑疾，有孚發若，吉。（豐盛到被遮蔽，中午見到星斗，前往被猜疑。若能誠信啟發，吉）",
            3: "九三：豐其沛，日中見沫，折其右肱，無咎。（被遮蔽得更深，中午見小星，如折斷右臂，無能為力，無災）",
            4: "九四：豐其蔀，日中見斗，遇其夷主，吉。（黑暗中遇見明主，吉）",
            5: "六五：來章，有慶譽，吉。（招來賢章之才，有喜慶美譽，吉）",
            6: "上六：豐其屋，蔀其家，窺其戶，闃其無人，三歲不覿，凶。（房屋高大，卻遮蔽了家，窺視門戶空無一人，三年不見人影，凶）"
        }
    },
    '離艮': {
        'num': 56,
        'name': '火山旅',
        'meaning': '小亨，旅貞吉。',
        'fortune': '中平。旅行、奔波。漂泊不定，依附他人。適合小事，大事難成，宜守正。',
        'lines': {
            1: "初六：旅瑣瑣，斯其所取災。（旅行猥瑣斤斤計較，自取災禍）",
            2: "六二：旅即次，懷其資，得童僕貞。（旅行找到客舍，懷揣資財，得到忠僕，吉）",
            3: "九三：旅焚其次，喪其童僕，貞厲。（客舍失火，失去童僕，處境危險）",
            4: "九四：旅于處，得其資斧，我心不快。（雖然找到住處且有盤纏，但寄人籬下，心中不快）",
            5: "六五：射雉，一矢亡，終以譽命。（射野雞，雖失一箭，但最終獲得名譽爵命）",
            6: "上九：鳥焚其巢，旅人先笑後號咷。喪牛于易，凶。（鳥巢被燒，先笑後哭。在牧場失牛，凶）"
        }
    },
    '巽巽': {
        'num': 57,
        'name': '巽為風',
        'meaning': '小亨，利有攸往，利見大人。',
        'fortune': '中上。順從、滲透。如風般無孔不入，順勢而為，柔順謙遜可獲利。',
        'lines': {
            1: "初六：進退，利武人之貞。（進退不決，利於像武人一樣果斷）",
            2: "九二：巽在床下，用史巫紛若，吉，無咎。（謙卑過度如在床下，需藉巫祝傳達誠意，吉）",
            3: "九三：頻巽，吝。（屢次顯得卑躬屈膝，令人羞恥）",
            4: "六四：悔亡，田獲三品。（悔恨消失，打獵收穫豐富，功勞顯著）",
            5: "九五：貞吉，悔亡，無不利。無初有終，先庚三日，後庚三日，吉。（堅守正道吉。雖開始不順但結果好，改革前後需慎重，吉）",
            6: "上九：巽在床下，喪其資斧，貞凶。（卑微到極點，失去資財與權力，凶）"
        }
    },
    '兌兌': {
        'num': 58,
        'name': '兌為澤',
        'meaning': '亨，利貞。',
        'fortune': '上上。喜悅、溝通。兩澤相連，互相滋益。善於言辭，人際和諧，心情愉快。',
        'lines': {
            1: "初九：和兌，吉。（平和地喜悅，不巴結奉承，吉）",
            2: "九二：孚兌，吉，悔亡。（心中有誠信的喜悅，吉，悔恨消失）",
            3: "六三：來兌，凶。（為了利益而來求悅，強顏歡笑，凶）",
            4: "九四：商兌，未寧，介疾有喜。（商量協調，未能安寧，但若能拒絕邪疾，會有喜事）",
            5: "九五：孚于剝，有厲。（信任剝削者小人，有危險）",
            6: "上六：引兌。（引誘別人一同享樂，易生是非）"
        }
    },
    '巽坎': {
        'num': 59,
        'name': '風水渙',
        'meaning': '亨。王假有廟，利涉大川，利貞。',
        'fortune': '中上。渙散、離散。但也有化解困難、掃除陰霾之意。利於凝聚人心，冒險犯難。',
        'lines': {
            1: "初六：用拯馬壯，吉。（借助強壯的馬匹來拯救，吉）",
            2: "九二：渙奔其機，悔亡。（在渙散時奔向依靠的几案，悔恨消失）",
            3: "六三：渙其躬，無悔。（犧牲小我，解救大眾，無悔）",
            4: "六四：渙其群，元吉。渙有丘，匪夷所思。（解散朋黨，大吉。聚沙成塔，力量大到不可思議）",
            5: "九五：渙汗其大號，渙王居，無咎。（像流汗一樣發布號令，收回王命重新凝聚，無災）",
            6: "上九：渙其血，去逖出，無咎。（遠離傷害流血的爭鬥，遠遠避開，無災）"
        }
    },
    '坎兌': {
        'num': 60,
        'name': '水澤節',
        'meaning': '亨。苦節不可貞。',
        'fortune': '中上。節制、規矩。適當的節制是美德，但過度限制則苦不堪言，宜中庸。',
        'lines': {
            1: "初九：不出戶庭，無咎。（知道時機未到，不出門庭，謹慎無災）",
            2: "九二：不出門庭，凶。（時機已到卻不出門，錯失良機，凶）",
            3: "六三：不節若，則嗟若，無咎。（不知節制，最終只能嘆息。這是自作自受，怪不得別人）",
            4: "六四：安節，亨。（安然守節，順應自然，亨通）",
            5: "九五：甘節，吉，往有尚。（甘之如飴地節制，吉，前行受推崇）",
            6: "上六：苦節，貞凶，悔亡。（過分節制令人痛苦，堅持這樣凶，若能悔改則亡）"
        }
    },
    '巽兌': {
        'num': 61,
        'name': '風澤中孚',
        'meaning': '豚魚吉，利涉大川，利貞。',
        'fortune': '上上。誠信感動萬物。心誠則靈，連豬魚都能感動。利於冒險，合作共事。',
        'lines': {
            1: "初九：虞吉，有它不燕。（專一安守則吉，心懷二意則不安）",
            2: "九二：鳴鶴在陰，其子和之，我有好爵，吾與爾靡之。（鶴在陰處鳴叫，小鶴應和。我有好酒，願與你共享，誠意相通）",
            3: "六三：得敵，或鼓或罷，或泣或歌。（遭遇勁敵，情緒起伏不定，或戰或停，或哭或笑）",
            4: "六四：月幾望，馬匹亡，無咎。（月亮將圓，良馬丟失。為了誠信犧牲小利，無災）",
            5: "九五：有孚攣如，無咎。（誠信緊密連結，無災）",
            6: "上九：翰音登于天，貞凶。（雞飛上天叫，虛聲無實，堅持這樣凶）"
        }
    },
    '震艮': {
        'num': 62,
        'name': '雷山小過',
        'meaning': '亨，利貞。可小事，不可大事。飛鳥遺之音，不宜上宜下，大吉。',
        'fortune': '中下。小有過越。飛鳥遺音，宜下不宜上。適合處理小事，大事不宜，宜低調謙下。',
        'lines': {
            1: "初六：飛鳥以凶。（飛鳥飛得過高，凶）",
            2: "六二：過其祖，遇其妣；不及其君，遇其臣；無咎。（越過祖父遇見祖母，未及君王遇見臣子。雖有逾越但不算太過，無災）",
            3: "九三：弗過防之，從或戕之，凶。（不加防備，可能被人傷害，凶）",
            4: "九四：無咎，弗過遇之。往厲必戒，勿用永貞。（無災，不逾越本分。前行危險需警惕，不可堅持不變）",
            5: "六五：密雲不雨，自我西郊，公弋取彼在穴。（密雲不雨，王公射取穴中的野獸，小有收穫）",
            6: "上六：弗遇過之，飛鳥離之，凶，是謂災眚。（不知收斂做得太過，如飛鳥遭網羅，凶，這是自招災禍）"
        }
    },
    '坎離': {
        'num': 63,
        'name': '水火既濟',
        'meaning': '亨，小利貞，初吉終亂。',
        'fortune': '中上。功德圓滿，盛極轉衰。初期順利，需防微杜漸，守成不易。',
        'lines': {
            1: "初九：曳其輪，濡其尾，無咎。（小心謹慎，寧可緩慢不可躁進，無災）",
            2: "六二：婦喪其茀，勿逐，七日得。（失去依憑，不必急於尋找，時機到自然回歸）",
            3: "九三：高宗伐鬼方，三年克之，小人勿用。（征伐艱難，需長期努力，不可任用小人）",
            4: "六四：繻有衣袽，終日戒。（防患未然，如船漏塞布，時刻警惕）",
            5: "九五：東鄰殺牛，不如西鄰之禴祭，實受其福。（鋪張浪費不如誠心實意，重在心意）",
            6: "上六：濡其首，厲。（渡河滅頂，不知進退，危險之極）"
        }
    },
    '離坎': {
        'num': 64,
        'name': '火水未濟',
        'meaning': '亨，小狐汔濟，濡其尾，無攸利。',
        'fortune': '中平。事業未成，充滿變數。代表新的開始，需辨別方向，重新出發。',
        'lines': {
            1: "初六：濡其尾，吝。（不知深淺，貿然行動，自取其辱）",
            2: "九二：曳其輪，貞吉。（控制速度，堅守中道，吉利）",
            3: "六三：未濟，征凶，利涉大川。（實力不足，強行進攻凶，宜等待時機或借助外力）",
            4: "九四：貞吉，悔亡，震用伐鬼方，三年有賞。（堅守正道，奮力拼搏，終獲獎賞）",
            5: "六五：貞吉，無悔，君子之光，有孚，吉。（光大正道，誠信感人，吉利）",
            6: "上九：有孚于飲酒，無咎，濡其首，有孚失是。（安享成果無妨，但若沉溺過度則會壞事）"
        }
    }
}

def get_divination_numbers():
    """生成三個占卜數字"""
    return random.randint(100, 999), random.randint(100, 999), random.randint(100, 999)

def calculate_hexagram(num1, num2, num3):
    """計算卦象"""
    upper_trigram = TRIGRAMS.get(num2 % 8, TRIGRAMS[1])
    lower_trigram = TRIGRAMS.get(num1 % 8, TRIGRAMS[1])
    hexagram_key = f"{upper_trigram['name']}{lower_trigram['name']}"
    
    # 如果找不到對應的卦，使用通用卦象
    if hexagram_key not in HEXAGRAMS:
        hexagram = {
            'num': 0,
            'name': f"{upper_trigram['name']}{lower_trigram['name']}卦",
            'meaning': f"上{upper_trigram['element']}下{lower_trigram['element']}之象。",
            'fortune': '中平'
        }
        print(f"警告：未找到卦象 {hexagram_key}，使用通用卦象")
    else:
        hexagram = HEXAGRAMS[hexagram_key]
    
    changing_line = 6 if (num3 % 6) == 0 else (num3 % 6)
    
    return {
        'upper_trigram': upper_trigram,
        'lower_trigram': lower_trigram,
        'hexagram': hexagram,
        'changing_line': changing_line,
        'numbers': (num1, num2, num3)
    }

def get_ai_interpretation(question, result):
    """獲取 AI 解讀"""
    if not client:
        return "（AI 解讀功能需要 OPENAI_API_KEY）\\n\\n根據卦象，這是一個關於變化與選擇的時刻。建議您保持內心平靜，審慎思考後再做決定。"
    
    hexagram = result['hexagram']
    upper = result['upper_trigram']
    lower = result['lower_trigram']
    changing_line = result['changing_line']
    
    prompt = f"""
你是易經占卜陳老師，請根據以下卦象為來訪者提供專業解讀。

【來訪者問題】
{question}

【卦象資訊】
本卦：第 {hexagram['num']} 卦 - {hexagram['name']}
上卦：{upper['name']}（{upper['element']}）{upper['symbol']}
下卦：{lower['name']}（{lower['element']}）{lower['symbol']}
卦義：{hexagram['meaning']}
運勢：{hexagram['fortune']}
變爻：第 {changing_line} 爻

請用溫和、專業的語氣提供解讀，包含實際建議（3-5點），字數控制在 300-400 字。
"""
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": "你是易經占卜陳老師。"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.7,
            max_tokens=800
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        return f"根據 {hexagram['name']} 的卦象，建議您保持{hexagram['fortune']}的心態。"

def determine_intent(question):
    """判斷用戶意圖"""
    question_lower = question.lower()
    
    divination_keywords = ["占卜", "算命", "運勢", "吉凶", "未來", "發展", "如何", "是否", "會不會"]
    persona_keywords = ["陳老師", "你", "您", "介紹", "背景", "聯絡"]
    
    divination_score = sum(1 for kw in divination_keywords if kw in question_lower)
    persona_score = sum(1 for kw in persona_keywords if kw in question_lower)
    
    if divination_score > persona_score:
        return 'DIVINATION'
    elif persona_score > 0:
        return 'PERSONA'
    else:
        return 'DIVINATION'

def get_ai_response(question, system_prompt):
    """獲取 AI 回應"""
    if not client:
        return "抱歉，AI 功能暫時無法使用。"
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": question}
            ],
            temperature=0.7,
            max_tokens=600
        )
        return response.choices[0].message.content.strip()
    except:
        return "抱歉，我目前無法回答這個問題。"

@app.route('/api/chat', methods=['POST'])
def chat():
    """聊天 API"""
    data = request.json
    message = data.get('message', '')
    user_numbers = data.get('numbers', None)  # 接收使用者抽到的數字
    
    if not message:
        return jsonify({'error': '請輸入問題'}), 400
    
    intent = determine_intent(message)
    
    if intent == 'DIVINATION':
        # 占卜
        if user_numbers and len(user_numbers) == 3:
            # 使用使用者抽到的數字
            num1, num2, num3 = user_numbers
        else:
            # 自動生成（備用）
            num1, num2, num3 = get_divination_numbers()
        
        result = calculate_hexagram(num1, num2, num3)
        interpretation = get_ai_interpretation(message, result)
        
        hexagram = result['hexagram']
        upper = result['upper_trigram']
        lower = result['lower_trigram']
        
        response_text = f"""╔═════════════════════════════════╗
║  🔮  易經占卜陳老師為您解卦  🔮 ║
╚═════════════════════════════════╝

【您的問題】
{message}

【起卦數字】
{num1}, {num2}, {num3}

【卦象資訊】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
本卦：第 {hexagram['num']} 卦 - {hexagram['name']}
上卦：{upper['name']} {upper['symbol']} （象徵{upper['element']}）
下卦：{lower['name']} {lower['symbol']} （象徵{lower['element']}）

卦義：{hexagram['meaning']}
運勢：{hexagram['fortune']}
動爻：第 {result['changing_line']} 爻
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【陳老師解讀】
{interpretation}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 提醒：占卜是一種自我認識的工具，最終的決定權在您手中。
╚═════════════════════════════════════════════════════╝
"""
        
        return jsonify({
            'response': response_text,
            'intent': 'DIVINATION',
            'hexagram_data': hexagram
        })
    
    else:
        # 背景問題
        response_text = get_ai_response(message, CHEN_LAOSHI_PERSONA)
        return jsonify({
            'response': response_text,
            'intent': 'PERSONA'
        })

@app.route('/api/health', methods=['GET'])
def health():
    """健康檢查"""
    return jsonify({'status': 'ok', 'openai': 'enabled' if client else 'disabled'})

if __name__ == '__main__':
    port = int(os.getenv('PORT', 5001))
    print("=" * 60)
    print("[*] 易經占卜 API 服務器啟動中...")
    print("=" * 60)
    if not OPENAI_API_KEY:
        print("[!] 警告：未設定 OPENAI_API_KEY")
    print(f"API 地址：http://0.0.0.0:{port}")
    print("=" * 60)
    app.run(host='0.0.0.0', port=port, debug=False)
